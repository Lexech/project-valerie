#summary Alles rund um's Synchronisieren
<wiki:toc max_depth="2" />
----
= Synchronisieren =
== Grundlagen ==
PVMC unterscheidet sich von einem "normalen" Videoplayer vor allem dadurch, dass zu den einzelnen Videos Zusatzinformationen angezeigt werden, z.B. Filmposter, kurze Inhaltsangabe, Erscheinungsjahr oder Genre. Diese Infos stehen ja nicht im Dateinamen des Videofiles und PVMC kann natürlich auch nicht den Inhalt des Videos "analysieren" - folglich muss PVMC diese Informationen "von irgendwoher" holen - und vor allem das Video "irgendwie" erkennen. Dieser (einmalige) Vorgang nennt sich Synchronisation: wurde ein Film erfolgreich erkannt und die zugehörigen Daten geladen, werden diese lokal in einer Datenbank gespeichert und sind später ohne erneute Synchronisation z.B. in der Film-Liste direkt anzeigbar.

Um zu verstehen, warum PVMC manchmal einen Film nicht erkennt - oder vielleicht sogar falsch erkennt, ist es wichtig, sich etwas näher mit dem Ablauf des Synchronisierens zu beschäftigen. Das hilft, Synchronisations-Probleme zu erkennen - und durch gezielte Hilfestellungen PVMC bei der Erkennungsrate auf die Sprünge zu helfen (s.u.). 

Wie eingangs erwähnt, müssen die Daten zu einem Film von irgendwoher geladen werden - folglich muss während eines Synchronisationslaufs eine funktionierende Internetverbindung bestehen. Als Datenquellen verwendet PVMC folgende Online-Datenbanken:
 * [http://www.imdb.com IMDB.com] => für Serien und Filme
 * [http://www.themoviedb.org TheMovieDB.org (TMDB)] => für Filme
 * [http://www.thetvdb.org TheTVDB.org (TVDB)] => für Serien
Für die weiteren Erklärungen sollen folgende Annahmen gelten: wir haben unsere Videosammlung getrennt nach Serien und Filmen in folgenden Verzeichnissen:

<code>
/hdd/videos/filme/A_Beautiful_Mind.avi
/hdd/videos/filme/Matrix.avi
/hdd/videos/filme/TopGun.avi
/hdd/videos/filme/X-Men.avi
...
/hdd/videos/serien/Breaking Bad/episode_s01e01_Titel.avi
/hdd/videos/serien/Breaking Bad/episode_s01e02_Titel.avi
...
/hdd/videos/serien/Breaking Bad/episode_s02e01_Titel.avi
/hdd/videos/serien/Breaking Bad/episode_s02e02_Titel.avi
...
/hdd/videos/serien/Criminal Minds/episode_s01e01_Titel.avi
...</code>
usw.

Natürlich kann man die Sammlung auch anders aufziehen - meine persönlichen Erfahrungen mit o.g. Schema sind aber gut, weshalb ich davon ausgehe, dass die skizzierte Vorgehensweise nicht die Schlechteste ist... :-)

Der prinzipielle Ablauf ist nun folgender:
 * PVMC lädt alle Video-Files, die in den zu syncenden Ordner enthalten sind
 * anschließend wird versucht zu ermitteln, ob es sich bei dem jeweiligen Video-File um einen Film oder um die Episode einer Serie handelt. Anhaltspunkte dazu liefern sowohl der Ordnertyp aus den Synchronisations-Einstellungen als auch die Dateinamen der einzelnen Video-Files. So wird z.B. überprüft, ob im Dateinamen die "typischen" Muster zum Beschreiben von Staffel- und Episoden-Nummern enthalten sind, also beispielsweise "s01e01" oder "1x01" etc.
 * in jedem Fall wird für jedes Video-File aus dem *Dateinamen* ein Suchstring gebildet, der dann für eine Suche bei der Online-Datenbank IMDb benutzt wird
 * als Ergebnis erhalten wir entweder eine eindeutige ID (die sogenannte IMDb-ID), mit der wir dann - je nach vermutetem Video-Typ (Film oder Serie) zur entsprechenden Online-Datenbank gehen, um Titel, Plot, Poster etc. zu holen. 

Besonders die vorletzte Zeile ist interessant, denn hier wird klar, dass es - ja nach Namensgebung des Videofiles - durchaus zu Problemen kommen kann: zum einen kann PVMC ja nicht "wissen", ob es sich bei dem vorliegenden Video um die Original-Version eines Films handelt - oder um den Remake, der vierzig Jahre später nochmal aufgenommen wurde, aber halt mit gleichem Namen. Oder der Dateiname liefert keine eindeutigen Suchergebnisse und dummerweise ist der eigentlich "richtige" Film in der Ergebnisliste an fünfter oder sechster Position!

Bezogen auf unsere o.g. Sammlung ist also wichtig, in den Synchronisations-Einstellungen den richtigen Ordnertyp für die beiden Ordner "filme" und "serien" zu wählen: der Ordner "filme" sollte als "MOVIE" gekennzeichnet sein - der Ordner "serien" analog als "TV". Den Typ "MOVIE_AND_TV" benötigen wir in diesem Fall nicht, da wir ja eine strikte Trennung zwischen Filmen und Serien haben.

Für das erste Video-File "`A_Beatiful_Mind.avi`" würde PVMC also anhand des Ordnertyps "MOVIE" erstmal davon ausgehen, dass es sich bei dem File um einen Film handelt. Dann wird überprüft, ob für dieses File evtl. Synchronisations-Hilfen vorhanden sind. Ist dies nicht der Fall, dann wird der Dateiname noch einw enig gepimpt - und anschließend eine IMDb-Abfrage mit folgendem String durchgeführt:

"a beautiful mind"

Als Ergebnis erhalten wir eine ganze Latte an Filmen, die bei IMDb gespeichert sind und "a beatiful mind" im Namen haben. An erster Stelle steht jedoch (glücklicherweise) der "richtige" Film: "A Beatiful Mind" aus dem Jahre 2001 mit Russell Crowe:

http://m.imdb.com/title/tt0268978/

In diesem Link finden wir nun auch die berühmt-berüchtigte IMDb-ID für diesen Film, nämlich `tt0268978`. Hätte es sich bei dem Video hingegen um das TV-Special "A Beautiful Mind: Creation of the Special Effects" aus dem Jahre 2002 gehandelt:

http://m.imdb.com/title/tt0780995/

dann müssten wir mit Hilfe der Suchhilfen PVMC auf die richtige Spur helfen, z.B. indem wir einfach die richtige IMDb-ID für dieses Special (nämlich `tt0780995`) in den Dateinamen mit aufnehmen, also die Videodatei wie folgt umbenennen:

`/hdd/videos/filme/A_Beautiful_Mind_tt0780995.avi`

Da es sich bei dem Video also um einen Film handelt, wendet sich PVMC mit dieser IMDb-ID an die Online-Datenbank TheMovieDB, um von dort den offiziellen Titel, den Plot, das Genre, die User-Bewertungen, sowie die Poster und Backdrops zu laden. Diese Daten werden dann in der PVMC-eigenen Datenbank abgelegt und lokal gespeichert. Im ersten Anlauf wird versucht, Titel und Plot in der eingestellten Synchronisations-Sprache zu laden. Ist das nicht möglich, wird es nochmal bei IMDb probiert. Wenn die Texte dort auch nicht in der gewünschten Sprache vorhanden sind, so wird als Fallback "Englisch" benutzt.

TODO


<br><br>
== Starten eines Synchronisationslaufs ==
In den Synchronisierungsmanager gelangt man über "Hauptmenu" => "System" => "Synchronize". Es stehen zwei Sychronisationsarten zur Auswahl:
 * eine komplette Synchronisation (auswählbar über die grüne Taste)
 * eine "schnelle" Synchronisation (auswählbar über die gelbe Taste)

Die komplette Synchronisation ist zur erstmaligen Einrichtung empfohlen. Sie durchsucht die im Suchpfad angegebenen Verzeichnisse und gleicht die dort gefundenen Medien-Dateien mit der Datenbank ab. Falls die Option "Film löschen wenn Datei nicht gefunden" aus den Haupteinstellungen aktiv ist, werden diejenigen Einträge aus der Datenbank entfernt, zu denen keine Dateien mehr gefunden wurden.<br>
Während der Synchronisation muss nicht zwingend im Synchronisierungsmanager gewartet werden, bis der Prozess fertig ist. Man kann mit Exit den Synchronisierungsbereich verlassen, dieser läuft dann als Hintergrundprozess weiter und blendet ein Popup Fenster ein, sobald alles abgeglichen ist.

Die "schnelle Synchronisation" hingegen fügt nur neue Titel hinzu und läuft dadurch bedeutend schneller ab.<br><br>
http://project-valerie.googlecode.com/svn/trunk/images/sync_small.png
<br><br>
== Einstellungen ==
Die Einstellungen für den Synchronisationsmanager sind über die blaue Taste erreichbar. Dort werden die für die Suche zu berücksichtigenden Verzeichnisse angegeben, sowie die für Plots und Titel zu verwendete Sprache festgelegt. Außerdem können dort Datenbank, Cache und Filter zurückgesetzt, bzw. gelöscht werden.

*Hinweis: nach Änderungen an den Einstellungen für den Synchronisationsmanager (insbesondere nach dem Wechsel der Synchronisations-Sprache), muss ein neuer Synchronisationslauf gestartet werden!*
<br><br>
== Medienprovider ==
Als Datenquelle für die Synchronisation dienen [http://www.imdb.com IMDB.com], [http://www.themoviedb.org TheMovieDB.org (TMDB)] und [http://www.thetvdb.org TheTVDB.org (TVDB)]. IMDB liefert primär die ID, während über die anderen Quellen Plot, Poster und Hintergrund usw. bezogen werden.
Zu beachten ist dabei folgendes:
 * zuerst werden TMDB, bzw. TVDB nach dem Plot in der ausgewählten Sprache befragt.
 * liegt der Plot nicht in der ausgewählten Sprache vor, wird bei IMDB für die ausgewählte Sprache nachgeschaut 
 * liegt dieser dort auch nicht vor, wird der englische Text von TMDB, resp. TVDB genommen
 * ist dieser dort auch nicht vorhanden, wird nochmals nach einem englischen Plot bei IMDB geschaut
Poster und Hintergrund werden aktuell ausschließlich von TMDB, bzw. TVDB in der eingestellten Sprache geholt. Sind diese dort *nicht* verfügbar, werden später in den Listen keine Grafiken angezeigt. In diesem Fall einfach selbst bei den entsprechenden Providern die Grafiken hochladen - dann haben alle etwas davon! :-) 
<br><br>
== Suchstrukturen ==
In der Datei `paths.conf` ist festgelegt, nach welchen Dateitypen in welchen Verzeichnissen gesucht wird (z.B. Dateiendungen "`mkv|ts|avi|m2ts`"), bzw. wie die Ordner kategorisiert sind (Filme => Kategorie "MOVIE", Serien => Kategorie "TV" oder beides => Kategorie "MOVIE_AND_TV"). Diese Datei kann entweder manuell editiert werden (eine entsprechende Datei mit Default-Werten wird bei der ersten Installation unter `/hdd/valerie` angelegt - siehe => [Resources#Konfigurationsdateien Konfigurationsdateien]) - oder aber über die Einstellungen des Syncmanagers. Zusätzlich kann für jeden Ordner separat konfiguriert werden, ob der Ordnername zum Abgleich benutzt werden soll oder die Dateinamen der einzelnen Files.

Beispielsweise könnte die eigene Sammlung wie folgt aufgeteilt werden:
 * `/hdd/movie` => Kategorie "MOVIE"
 * `/hdd/series` => Kategorie "TV"
 * `/hdd/gemischt` => Kategorie "MOVIE_AND_TV"
Nach einem Synchronisationslauf würden die im "`/hdd/movie`"-Ordner enthaltenen Files zur "Film"-Liste zugeordnet. Die im "`/hdd/series`"-Verzeichnis enthaltenen Dateien werden als Serien interpretiert und die im "`gemischt`"-Ordner enthaltenen Dateien werden entweder als Film gesucht - und wenn dort nichts gefunden wird, als Serie interpretiert.

Zur Erkennung der Videos werden folgende Kriterien herangezogen:
 * der Name der Datei ohne Dateityperweiterung (default). Der für die Suchanfrage benutzte String kann aber vor Ausführen der eigentlichen Suche noch durch Reguläre Ausdrücke verändert werden (s.u.)
 * der Name des Ordners, in dem die Datei enthalten ist (einstellbar in den Synchronisationsmanager-Optionen ([Sync#Einstellungen s.o.])
 * eine IMDB-Id, die über eine selbst anzulegende `nfo`-Datei vorgegeben wird
 * bei selbst erstellten Aufnahmen wird der Titel (bzw. Staffel und Episode bei Serien) aus der zugehörigen Enigma2 `meta`-Datei gelesen
Falsch erkannte Einträge können anschließend manuell korrigiert werden ([Sync#Suchergebnis_manuell_korrigieren s.u.]).
<br>
=== DVDs ===
Valerie erkennt Filme die in mehreren Dateien vorliegen anhand des Namens. Eine Ausnahme sind Ordner mit einer DVD Struktur (`*`.vob, `*`.ifo) als Inhalt. Da hier anhand des Dateinamens keine Suche gestartet werden kann, wird in solchen Fällen immer der Ordnername als Suchbegriff verwendet.
<br>
=== Suchergebnis manuell korrigieren ===
Wurde ein Titel nicht oder falsch erkannt, so kann dies über den Punkt "Verwalten" im Menu des Synchronisations-Manager korrigiert werden. Ausserdem kann man gezielt einzelne Filme dort aktualisieren, oder aus der Datenbank löschen. Dazu muss der jeweilige Film (entsprechenen aus der Rubrik "Fehlgeschlagen|Filme|TV Shows|TV Shows (all)") ausgewählt und mit OK bestätigt werden.
Dann kann man entweder über "Alternativen" das richtige Suchergebnis auswählen und bestätigen (sofern nicht als UNKNOWN markiert), oder aber gezielt die IMDB-ID (über "MORE") eingeben und speichern.
<br><br>
http://project-valerie.googlecode.com/svn/trunk/images/manage_small.png<br>
<br>
*HINWEIS:*<br>
Besteht ein Titel aus mehreren Dateien, so wird nur der erste Teil in die Datenbank aufgenommen, die anderen Teile landen in der failded.db. Wird der erste Teil abgespielt, so startet im Anschluss an den ersten der nächste Teil. Damit Valerie erkennt, dass es sich um Multipart Titel handelt, muss eine der folgenden Syntaxmöglichkeiten (+ laufende Nummer, startend mit 1) verwendet werden:<br>
  * disk<br>
  * cd<br>
  * dvd<br>
  * part<br>
  * pt
<br>
z.B: Film XY - disk1.avi, Film XY - disk2.avi
<br><br>
== Excludes und Suchhilfen ==
Valerie bietet mehrere Möglichkeiten, das Suchergebnis zu beeinflussen:

 * komplette Ordner von der Suche ausklammern
 * die IMDb-Id im Namen der Videodatei angeben
 * die IMDb-Id in einer nfo-Datei angeben
 * Suchwörter oder IMDb-ID / TheTvDB-iD für einen kompletten Ordner definieren
 * zusätzliche Meta-Daten in einer nfo-Datei angeben

Wie das im Detail geht, wird in den nachfolgenden Kapiteln ausführlicher beschrieben. Zu beachten ist dabei aber, dass in allen Fällen nach einer Änderung eine bereits vorhandene Datenbank durch eine *komplette* Synchronisation neu aufgebaut wird (also keine "schnelle" Synchronisation).
=== Ordner von der Suche ausklammern ===
Um einen kompletten Ordner sowie desen Unterordner von der Suche auszuklammern, muss man lediglich eine Datei `ignore` in diesen Ordner erstellen.

=== IMDb ID aus Dateinamen auslesen ===
Wird ein Videofile nicht richtig erkannt, obwohl bei IMDb ein Eintrag dafür vorhanden ist, so ist es möglich, Valerie durch die Angabe der "richtigen" IMDb-ID auf die richtige Spur zu bringen. Dazu muss lediglich die IMDb-ID Zeichenkette (incl. den obligatorischen "tt") in den Dateinamen mit aufgenommen werden:

*Dateiname des Videofiles (alt):* {{{NichtErkannterFilm.avi}}}

*Dateiname des Videofiles (neu):* {{{NichtErkannterFilm_tt1234567.avi}}}

Der Unterstrich "`_`" ist dabei nicht zwingend notwendig - auch ist es egal, an welcher Stelle im Dateinamen die Zeichenkette steht - wichtig ist nur, dass sie mit "tt" beginnt und anschließend sieben Ziffern folgen. Außerdem ist zu beachten, dass eine IMDb-ID, die über den dateinamen mitgegeben wurde, von einer IMDb-ID, die aus einer nfo-Datei stammt, überschrieben wird (s. nächstes Kapitel).

=== IMDb ID über nfo-Datei angeben ===
Eine weitere Möglichkeit, die richtige IMDb-ID für einen nicht korrekt erkannten Film anzugeben, ist eine nfo-Datei. Diese muss im gleichen Verzeichnis wie die Film-Datei liegen und den gleichen Namen haben - allerdings mit der Dateierweiterung "`nfo`". Als Inhalt genügt die Zeichenkette für die IMDb-ID - momentan müssen allerdings _zwingend zwei Zeilen_ in der Datei enthalten sein! Beispiel:

*Dateiname des Videofiles:* {{{NichtErkannterFilm.avi}}}

*Dateiname des nfo-Files:* {{{NichtErkannterFilm.nfo}}}

*Inhalt des nfo-Files:*

<code>tt1234567
</code>

Vor der IMDb-ID kann durchaus noch weiterer Text stehen, z.B. könnte man einfach direkt den IMDb-Link zu dem Film in die Datei kopieren, was ebenfalls funktionieren sollte:

*Alternativer Inhalt des nfo-Files:*

<code>http://www.imdb.com/title/tt1234567/
</code>

=== Suchwoerter für einen kompletten Ordner (valerie.info) ===
Neben den o.g. Möglichkeiten kann mittels einer neu zu erstellenden Datei `valerie.info` ein Suchwort bereitgestellt werden, das für den gesamten Ordner gilt. Dies ist Hilfreich bei Serien, bei denen sonst für jeden Episodentitel eine eigene NFO-Datei erstellt werden müsste.
Im entsprechenden Ordner der Serie muss eine neue Datei `valerie.info` mit einem Text-Editor erzeugt werden, deren Inhalt ein (oder mehrere) möglichst eindeutige Suchworte sein sollte, mit deren Hilfe der Inhalt des Video-Files auf IMDB gefunden werden kann.

*HINWEIS:*
Der bereitgestellte Suchbegriff gilt nur für den Inhalt des Ordners, aber nicht für etwaige vorhandene Unterordner!

Zusätzlich ist es möglich, mit einer solchen `valerie.info` entweder 
 * direkt die IMDb-ID
 * oder die TheTvDB-ID
 * oder beide IDs

anzugeben! 

*Bitte beachten:*
Zur Zeit ist es notwendig, dass der Inhalt der `valerie.info` mit einer Leerzeile beendet wird! Andernfalls ist es möglich, dass die letzte Ziffer der spezifizierten Datei abgeschnitten wird!

Beispiel-Inhalt für eine `valerie.info`, mit der man eine IMDb-ID für den Ordner spezifiziert:

<code>tt1234567
</code>

Beispiel-Inhalt für eine `valerie.info`, mit der man eine TheTvDB-ID für den Ordner spezifiziert:

<code><tvdb>tvdb12345
</code>

Beispiel-Inhalt für eine `valerie.info`, mit der man sowohl die IMDb-ID als auch die TheTvDB-ID für den Ordner spezifiziert:

<code>tt1234567 <tvdb>tvdb12345
</code>


=== Metadaten des Films aus xbmc-style nfo-File lesen ===
Zusätzlich zu den o.g. Möglichkeiten ist geplant, nfo-Files zu unterstützen, die von XBMC benutzt werden, um die gesamten Metadaten eines Videos auszulesen. Bisher wird von PVMC aber nur eine kleine Anzahl an Parametern unterstützt:
 * `<id>` => IMDb-ID für Film / Serie
 * `<episodedetails>` => IMDb-ID für Episoden
 * `<season>` => Staffel-Nummer bei Serien
 * `<episode>` => Episoden-Nummer bei Serien
 * `<year>` => Jahr
Diese Funktionalität ist leider noch nicht komplett implementiert, zumal mit dem "Plot"-Attribut eine wichtige Eigenschaft fehlt, um "unbekannte" Filme oder Dokumentationen unabhängig von IMDb, TheMovieDb oder TheTvDb in die PVMC-Datenbank zu bekommen. 

=== Regulaere Ausdruecke ===
Mit Hilfe der in den Config-Files "`pre.conf`", "`post_movie.conf`", sowie "`post_tv.conf`" festgelegten Regulären Ausdrücke können die Suchstrings, die an die Medienprovider übergeben werden, beeinflusst werden:
 * die `pre.conf` gilt sowohl für Filme als auch für Serien
 * die `post_movie.conf` gilt nur für Filme
 * die `post_tv.conf` nur für Serien<br>
Beispiel:<br>
Angenommen der Titel hat folgenden Dateinamen:<br> "`The.Beach.2000.720p.HDTV.x264-ESiR.mkv`"<br>
Valerie würde mit Standardeinstellungen folgendes als Suchstring verwenden: "`The Beach 2000 ESiR`"<br>
Da das Ergebnis nicht eindeutig ist, wird der "best match" verwendet. In diesem Fall "`Beach Tennis USA: The Road to Long Beach 2009`". Um dem vorzubeugen, können über sogenannte "Reguläre Ausdrücke" bestimmte Wörter oder Zeichenketten herausgefiltert werden, damit ein möglichst eindeutiger Suchbegriff übergeben wird.<br>
Mehr zu regulären Ausdrücken kann auf [http://www.zdnet.de/anwendungsentwicklung_regular_expressions_syntax_entraetselt_story-20000201-20000839-1.htm ZDNET] nachgelesen werden. Um eigene reguläre Ausdrücke zu überprüfen eignet sich folgendes online [http://gskinner.com/RegExr RegEx Tool]<br>
<br>
